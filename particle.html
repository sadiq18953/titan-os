<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TITAN OS | PARTICLE STORM</title>
    <style>
      /* === TITAN OS THEME === */
      :root {
        --bg-void: #000000;
        --bg-deep: #050505;
        --accent-blue: #3b82f6;
        --accent-purple: #8b5cf6;
        --accent-pink: #ec4899;
        --accent-cyan: #06b6d4;
        --accent-red: #ef4444;
        --accent-green: #10b981;
        --accent-yellow: #f59e0b;
        --text-light: #f1f5f9;
        --text-dim: #94a3b8;
        --glass-dark: rgba(30, 41, 59, 0.8);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glow-blue: 0 0 20px rgba(59, 130, 246, 0.4);
        --glow-purple: 0 0 20px rgba(139, 92, 246, 0.4);
        --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        background: var(--bg-void);
        min-height: 100vh;
        overflow: hidden;
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        color: var(--text-light);
      }

      /* === BACK BUTTON === */
      .back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 12px 20px;
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid var(--accent-blue);
        border-radius: 12px;
        color: var(--accent-blue);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
        backdrop-filter: blur(10px);
      }

      .back-btn:hover {
        background: var(--accent-blue);
        color: white;
        transform: translateX(-5px);
      }

      /* === START SCREEN === */
      .start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(5, 5, 5, 0.98);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(10px);
        padding: 20px;
      }

      .start-title {
        font-size: clamp(2rem, 5vw, 3.5rem);
        font-weight: 800;
        background: linear-gradient(
          90deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 10px;
        text-align: center;
        line-height: 1.2;
      }

      .start-subtitle {
        font-size: 1.2rem;
        color: var(--text-dim);
        margin-bottom: 40px;
        text-align: center;
      }

      .mode-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 40px;
        width: 100%;
        max-width: 500px;
      }

      .mode-card {
        padding: 25px;
        background: var(--glass-dark);
        border-radius: 20px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        backdrop-filter: blur(10px);
      }

      .mode-card:hover {
        transform: translateY(-5px);
        border-color: var(--accent-blue);
        box-shadow: var(--glow-blue);
      }

      .mode-card.active {
        border-color: var(--accent-blue);
        background: rgba(59, 130, 246, 0.1);
        box-shadow: var(--glow-blue);
      }

      .mode-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
      }

      .mode-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 10px;
        color: white;
      }

      .mode-desc {
        font-size: 0.85rem;
        color: var(--text-dim);
        line-height: 1.4;
      }

      .difficulty-selector {
        margin-bottom: 40px;
        text-align: center;
        opacity: 0;
        height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
        width: 100%;
        max-width: 500px;
      }

      .difficulty-selector.show {
        opacity: 1;
        height: auto;
      }

      .difficulty-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }

      .diff-btn {
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: var(--text-dim);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .diff-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }

      .diff-btn.active {
        background: linear-gradient(
          135deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }

      .start-btn {
        padding: 16px 40px;
        background: linear-gradient(
          135deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        border: none;
        border-radius: 16px;
        color: white;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        text-transform: uppercase;
        letter-spacing: 1px;
        width: 100%;
        max-width: 300px;
      }

      .start-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5);
      }

      /* === GAME CONTAINER === */
      .game-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 50;
      }

      /* === HUD === */
      .hud {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        pointer-events: none;
      }

      .hud-item {
        background: var(--glass-dark);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 120px;
      }

      .hud-icon {
        font-size: 1.2rem;
      }

      .hud-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--accent-cyan);
      }

      .hud-label {
        font-size: 0.8rem;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .health-bar {
        width: 200px;
        height: 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        overflow: hidden;
      }

      .health-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-green), #4ade80);
        border-radius: 6px;
        transition: width 0.3s ease;
      }

      /* === GAME OVER SCREEN === */
      .game-over {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(5, 5, 5, 0.95);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 200;
        backdrop-filter: blur(10px);
      }

      .game-over-content {
        background: var(--glass-dark);
        padding: 40px;
        border-radius: 24px;
        text-align: center;
        width: 90%;
        max-width: 500px;
        border: 1px solid var(--glass-border);
      }

      .game-over-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 20px;
        background: linear-gradient(
          90deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 30px 0;
      }

      .stat {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 12px;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
      }

      .stat-label {
        font-size: 0.8rem;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* === CONTROLS === */
      .controls {
        position: fixed;
        bottom: 30px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 20px;
        z-index: 100;
      }

      .control-btn {
        width: 70px;
        height: 70px;
        background: var(--glass-dark);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--text-light);
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        -webkit-user-select: none;
      }

      .control-btn:active {
        background: rgba(59, 130, 246, 0.2);
        transform: scale(0.95);
      }

      .joystick-area {
        position: fixed;
        bottom: 30px;
        left: 30px;
        width: 150px;
        height: 150px;
        pointer-events: none;
      }

      .joystick-base {
        width: 100px;
        height: 100px;
        background: rgba(59, 130, 246, 0.1);
        border: 2px solid var(--accent-blue);
        border-radius: 50%;
        position: absolute;
        bottom: 0;
        left: 0;
        backdrop-filter: blur(10px);
      }

      .joystick-handle {
        width: 50px;
        height: 50px;
        background: var(--accent-blue);
        border-radius: 50%;
        position: absolute;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 20px var(--accent-blue);
        transition: transform 0.1s ease;
      }

      /* === CANVAS === */
      #gameCanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      /* === POWER UP INDICATORS === */
      .power-ups {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
      }

      .power-up {
        background: var(--glass-dark);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 180px;
        opacity: 0.5;
        transition: all 0.3s ease;
      }

      .power-up.active {
        opacity: 1;
        border-color: var(--accent-yellow);
        box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
      }

      .power-up-icon {
        font-size: 1.2rem;
      }

      .power-up-bar {
        flex: 1;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
      }

      .power-up-fill {
        height: 100%;
        background: var(--accent-yellow);
        border-radius: 2px;
      }

      /* === MOBILE OPTIMIZATION === */
      @media (max-width: 768px) {
        .mode-selector {
          grid-template-columns: 1fr;
        }

        .hud {
          padding: 10px;
        }

        .hud-item {
          padding: 8px 12px;
          min-width: 100px;
        }

        .health-bar {
          width: 150px;
        }

        .controls {
          bottom: 20px;
        }

        .control-btn {
          width: 60px;
          height: 60px;
          font-size: 1.3rem;
        }

        .joystick-area {
          left: 20px;
          bottom: 20px;
          width: 120px;
          height: 120px;
        }

        .joystick-base {
          width: 80px;
          height: 80px;
        }

        .power-ups {
          bottom: 20px;
          right: 20px;
        }

        .power-up {
          min-width: 150px;
          padding: 8px 12px;
        }
      }

      /* === WAVE INDICATOR === */
      .wave-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--glass-dark);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 20px 40px;
        text-align: center;
        z-index: 150;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .wave-indicator.show {
        opacity: 1;
      }

      .wave-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-cyan);
        margin-bottom: 5px;
      }

      .wave-subtitle {
        font-size: 0.9rem;
        color: var(--text-dim);
      }
    </style>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Back Button -->
    <a href="index.html" class="back-btn"> ‚Üê Back to OS </a>

    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
      <h1 class="start-title">PARTICLE STORM</h1>
      <div class="start-subtitle">
        Geometry Wars-inspired twin-stick shooter
      </div>

      <div class="mode-selector">
        <div
          class="mode-card"
          data-mode="survival"
          onclick="selectMode('survival')"
        >
          <div class="mode-icon">üíÄ</div>
          <div class="mode-title">SURVIVAL</div>
          <div class="mode-desc">
            Survive endless waves of enemies. How long can you last?
          </div>
        </div>

        <div
          class="mode-card"
          data-mode="campaign"
          onclick="selectMode('campaign')"
        >
          <div class="mode-icon">üéØ</div>
          <div class="mode-title">CAMPAIGN</div>
          <div class="mode-desc">
            10 waves with increasing difficulty. Beat them all!
          </div>
        </div>
      </div>

      <div class="difficulty-selector" id="difficultySelector">
        <div
          class="difficulty-title"
          style="margin-bottom: 15px; color: var(--text-dim)"
        >
          Select Difficulty
        </div>
        <div class="difficulty-buttons">
          <button
            class="diff-btn"
            data-diff="easy"
            onclick="selectDifficulty('easy')"
          >
            Easy
          </button>
          <button
            class="diff-btn active"
            data-diff="normal"
            onclick="selectDifficulty('normal')"
          >
            Normal
          </button>
          <button
            class="diff-btn"
            data-diff="hard"
            onclick="selectDifficulty('hard')"
          >
            Hard
          </button>
          <button
            class="diff-btn"
            data-diff="insane"
            onclick="selectDifficulty('insane')"
          >
            Insane
          </button>
        </div>
      </div>

      <button class="start-btn" onclick="startGame()" id="startBtn">
        Start Game
      </button>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- Game Container -->
    <div class="game-container" id="gameContainer">
      <!-- HUD -->
      <div class="hud">
        <div class="hud-item">
          <div class="hud-icon">üéØ</div>
          <div>
            <div class="hud-value" id="score">0</div>
            <div class="hud-label">Score</div>
          </div>
        </div>

        <div class="hud-item">
          <div class="hud-icon">üíÄ</div>
          <div>
            <div class="hud-value" id="wave">1</div>
            <div class="hud-label">Wave</div>
          </div>
        </div>

        <div class="hud-item">
          <div class="hud-icon">‚ù§Ô∏è</div>
          <div style="width: 200px">
            <div class="hud-label" style="margin-bottom: 5px">Shield</div>
            <div class="health-bar">
              <div class="health-fill" id="healthBar" style="width: 100%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Power Ups -->
      <div class="power-ups">
        <div class="power-up" id="powerRapid">
          <div class="power-up-icon">‚ö°</div>
          <div style="flex: 1">
            <div style="font-size: 0.8rem; color: var(--text-light)">
              Rapid Fire
            </div>
            <div class="power-up-bar">
              <div class="power-up-fill" id="rapidBar"></div>
            </div>
          </div>
        </div>

        <div class="power-up" id="powerShield">
          <div class="power-up-icon">üõ°Ô∏è</div>
          <div style="flex: 1">
            <div style="font-size: 0.8rem; color: var(--text-light)">
              Force Field
            </div>
            <div class="power-up-bar">
              <div class="power-up-fill" id="shieldBar"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div
          class="control-btn"
          id="btnShoot"
          ontouchstart="startShooting()"
          ontouchend="stopShooting()"
          onmousedown="startShooting()"
          onmouseup="stopShooting()"
          onmouseleave="stopShooting()"
        >
          üî•
        </div>
        <div class="control-btn" id="btnBomb" onclick="useBomb()">üí£</div>
        <div class="control-btn" id="btnPause" onclick="togglePause()">‚è∏Ô∏è</div>
      </div>

      <!-- Joystick -->
      <div class="joystick-area" id="joystickArea">
        <div class="joystick-base"></div>
        <div class="joystick-handle" id="joystickHandle"></div>
      </div>

      <!-- Wave Indicator -->
      <div class="wave-indicator" id="waveIndicator">
        <div class="wave-title" id="waveTitle">WAVE 1</div>
        <div class="wave-subtitle" id="waveSubtitle">Get ready!</div>
      </div>
    </div>

    <!-- Game Over Screen -->
    <div class="game-over" id="gameOver">
      <div class="game-over-content">
        <div class="game-over-title" id="gameOverTitle">GAME OVER</div>

        <div class="stats-grid">
          <div class="stat">
            <div class="stat-value" id="finalScore">0</div>
            <div class="stat-label">Score</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="finalWave">0</div>
            <div class="stat-label">Wave</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="finalKills">0</div>
            <div class="stat-label">Kills</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="finalTime">0:00</div>
            <div class="stat-label">Time</div>
          </div>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 30px">
          <button
            class="start-btn"
            style="max-width: 200px"
            onclick="restartGame()"
          >
            Play Again
          </button>
          <button
            class="start-btn"
            style="max-width: 200px; background: rgba(255, 255, 255, 0.1)"
            onclick="backToMenu()"
          >
            Main Menu
          </button>
        </div>
      </div>
    </div>

    <script>
      // ===== GAME CONFIGURATION =====
      const CONFIG = {
        CANVAS_WIDTH: 1920,
        CANVAS_HEIGHT: 1080,
        PLAYER_SPEED: 5,
        PLAYER_SIZE: 20,
        ENEMY_SPEED: {
          easy: 1.5,
          normal: 2,
          hard: 2.5,
          insane: 3,
        },
        ENEMY_SPAWN_RATE: {
          easy: 60,
          normal: 45,
          hard: 30,
          insane: 20,
        },
        WAVES: {
          survival: Infinity,
          campaign: 10,
        },
      };

      // ===== GAME STATE =====
      const gameState = {
        // Game mode
        mode: "survival",
        difficulty: "normal",

        // Player state
        player: {
          x: CONFIG.CANVAS_WIDTH / 2,
          y: CONFIG.CANVAS_HEIGHT / 2,
          health: 100,
          maxHealth: 100,
          score: 0,
          kills: 0,
          bombs: 3,
          speed: CONFIG.PLAYER_SPEED,
          invulnerable: false,
          invulnerableTimer: 0,
        },

        // Power ups
        powerUps: {
          rapid: { active: false, timer: 0, maxTime: 10 },
          shield: { active: false, timer: 0, maxTime: 8 },
        },

        // Game objects
        bullets: [],
        enemies: [],
        particles: [],
        powerUps: [],

        // Game state
        wave: 1,
        waveEnemies: 0,
        enemiesKilled: 0,
        gameTime: 0,
        gameActive: false,
        gamePaused: false,
        shooting: false,
        lastShot: 0,
        lastSpawn: 0,
        joystick: { active: false, x: 0, y: 0, baseX: 0, baseY: 0 },

        // Audio
        audioContext: null,
        soundEnabled: true,
      };

      // ===== CANVAS SETUP =====
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      let canvasScale = 1;

      function resizeCanvas() {
        const width = window.innerWidth;
        const height = window.innerHeight;

        // Maintain aspect ratio
        const scale = Math.min(
          width / CONFIG.CANVAS_WIDTH,
          height / CONFIG.CANVAS_HEIGHT,
        );
        canvasScale = scale;

        canvas.width = CONFIG.CANVAS_WIDTH;
        canvas.height = CONFIG.CANVAS_HEIGHT;
        canvas.style.width = `${CONFIG.CANVAS_WIDTH * scale}px`;
        canvas.style.height = `${CONFIG.CANVAS_HEIGHT * scale}px`;
      }

      // ===== START SCREEN FUNCTIONS =====
      function selectMode(mode) {
        gameState.mode = mode;

        document.querySelectorAll(".mode-card").forEach((card) => {
          card.classList.toggle("active", card.dataset.mode === mode);
        });

        const diffSelector = document.getElementById("difficultySelector");
        diffSelector.classList.add("show");

        const startBtn = document.getElementById("startBtn");
        startBtn.textContent = `Start ${mode.charAt(0).toUpperCase() + mode.slice(1)}`;
      }

      function selectDifficulty(difficulty) {
        gameState.difficulty = difficulty;

        document.querySelectorAll(".diff-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.diff === difficulty);
        });
      }

      function startGame() {
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("gameContainer").style.display = "block";
        gameState.gameActive = true;

        // Initialize game state
        gameState.player = {
          x: CONFIG.CANVAS_WIDTH / 2,
          y: CONFIG.CANVAS_HEIGHT / 2,
          health: 100,
          maxHealth: 100,
          score: 0,
          kills: 0,
          bombs: 3,
          speed: CONFIG.PLAYER_SPEED,
          invulnerable: false,
          invulnerableTimer: 0,
        };

        gameState.wave = 1;
        gameState.enemiesKilled = 0;
        gameState.waveEnemies = calculateWaveEnemies();
        gameState.gameTime = 0;
        gameState.bullets = [];
        gameState.enemies = [];
        gameState.particles = [];
        gameState.powerUps = [];

        updateHUD();
        showWaveIndicator();
        gameLoop();

        // Initialize audio
        if (!gameState.audioContext) {
          gameState.audioContext = new (
            window.AudioContext || window.webkitAudioContext
          )();
        }

        // Setup joystick
        setupJoystick();
      }

      function backToMenu() {
        document.getElementById("gameContainer").style.display = "none";
        document.getElementById("gameOver").style.display = "none";
        document.getElementById("startScreen").style.display = "flex";
        gameState.gameActive = false;
      }

      function showWaveIndicator() {
        const indicator = document.getElementById("waveIndicator");
        const title = document.getElementById("waveTitle");
        const subtitle = document.getElementById("waveSubtitle");

        title.textContent = `WAVE ${gameState.wave}`;

        if (gameState.mode === "campaign") {
          subtitle.textContent = `${gameState.wave}/${CONFIG.WAVES.campaign}`;
        } else {
          subtitle.textContent = "Survive!";
        }

        indicator.classList.add("show");
        setTimeout(() => indicator.classList.remove("show"), 2000);
      }

      // ===== GAME LOGIC =====
      function calculateWaveEnemies() {
        const base = 5 + gameState.wave * 3;
        const multiplier = {
          easy: 0.7,
          normal: 1,
          hard: 1.3,
          insane: 1.6,
        }[gameState.difficulty];

        return Math.floor(base * multiplier);
      }

      function spawnEnemy() {
        const side = Math.floor(Math.random() * 4);
        let x, y;

        switch (side) {
          case 0: // Top
            x = Math.random() * CONFIG.CANVAS_WIDTH;
            y = -50;
            break;
          case 1: // Right
            x = CONFIG.CANVAS_WIDTH + 50;
            y = Math.random() * CONFIG.CANVAS_HEIGHT;
            break;
          case 2: // Bottom
            x = Math.random() * CONFIG.CANVAS_WIDTH;
            y = CONFIG.CANVAS_HEIGHT + 50;
            break;
          case 3: // Left
            x = -50;
            y = Math.random() * CONFIG.CANVAS_HEIGHT;
            break;
        }

        const speed = CONFIG.ENEMY_SPEED[gameState.difficulty];
        const size = 15 + Math.random() * 10;

        gameState.enemies.push({
          x,
          y,
          size,
          speed,
          color: Math.random() > 0.3 ? "#ef4444" : "#8b5cf6",
          health: 1,
          type: Math.random() > 0.8 ? "fast" : "normal",
        });
      }

      function spawnPowerUp(x, y) {
        if (Math.random() > 0.3) return;

        const types = ["rapid", "shield", "health", "bomb"];
        const type = types[Math.floor(Math.random() * types.length)];
        let color, icon;

        switch (type) {
          case "rapid":
            color = "#f59e0b";
            icon = "‚ö°";
            break;
          case "shield":
            color = "#06b6d4";
            icon = "üõ°Ô∏è";
            break;
          case "health":
            color = "#10b981";
            icon = "‚ù§Ô∏è";
            break;
          case "bomb":
            color = "#ec4899";
            icon = "üí£";
            break;
        }

        gameState.powerUps.push({
          x,
          y,
          type,
          color,
          icon,
          size: 15,
          lifetime: 300,
        });
      }

      function shoot() {
        const now = Date.now();
        const fireRate = gameState.powerUps.rapid.active ? 50 : 150;

        if (now - gameState.lastShot < fireRate) return;

        gameState.lastShot = now;

        // Calculate shooting direction (towards center of screen for now)
        // In a real twin-stick shooter, this would be controlled by a second joystick
        const angle = Math.atan2(
          CONFIG.CANVAS_HEIGHT / 2 - gameState.player.y,
          CONFIG.CANVAS_WIDTH / 2 - gameState.player.x,
        );

        gameState.bullets.push({
          x: gameState.player.x,
          y: gameState.player.y,
          vx: Math.cos(angle) * 10,
          vy: Math.sin(angle) * 10,
          size: 5,
          color: "#3b82f6",
          lifetime: 100,
        });

        playSound(800, "square", 0.1);
      }

      function useBomb() {
        if (gameState.player.bombs <= 0) return;

        gameState.player.bombs--;
        playSound(200, "sawtooth", 0.2);

        // Create explosion particles
        for (let i = 0; i < 100; i++) {
          const angle = Math.random() * Math.PI * 2;
          const speed = 2 + Math.random() * 8;

          gameState.particles.push({
            x: gameState.player.x,
            y: gameState.player.y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            size: 3 + Math.random() * 7,
            color: "#f59e0b",
            life: 1,
            decay: 0.02,
          });
        }

        // Kill all enemies on screen
        gameState.enemies.forEach((enemy) => {
          gameState.player.kills++;
          gameState.player.score += 100;
          spawnPowerUp(enemy.x, enemy.y);
        });

        gameState.enemies = [];
      }

      function takeDamage(amount) {
        if (gameState.player.invulnerable || gameState.powerUps.shield.active)
          return;

        gameState.player.health -= amount;
        gameState.player.invulnerable = true;
        gameState.player.invulnerableTimer = 60;

        playSound(200, "sine", 0.2);

        if (gameState.player.health <= 0) {
          gameOver();
        }

        updateHUD();
      }

      function collectPowerUp(powerUp) {
        playSound(600, "sine", 0.1);

        switch (powerUp.type) {
          case "rapid":
            gameState.powerUps.rapid.active = true;
            gameState.powerUps.rapid.timer = gameState.powerUps.rapid.maxTime;
            document.getElementById("powerRapid").classList.add("active");
            break;

          case "shield":
            gameState.powerUps.shield.active = true;
            gameState.powerUps.shield.timer = gameState.powerUps.shield.maxTime;
            document.getElementById("powerShield").classList.add("active");
            break;

          case "health":
            gameState.player.health = Math.min(
              gameState.player.maxHealth,
              gameState.player.health + 30,
            );
            updateHUD();
            break;

          case "bomb":
            gameState.player.bombs++;
            break;
        }
      }

      function gameOver() {
        gameState.gameActive = false;

        document.getElementById("finalScore").textContent =
          gameState.player.score;
        document.getElementById("finalWave").textContent = gameState.wave;
        document.getElementById("finalKills").textContent =
          gameState.player.kills;
        document.getElementById("finalTime").textContent = formatTime(
          gameState.gameTime,
        );

        document.getElementById("gameOver").style.display = "flex";
      }

      function restartGame() {
        document.getElementById("gameOver").style.display = "none";
        startGame();
      }

      function togglePause() {
        gameState.gamePaused = !gameState.gamePaused;
        const btn = document.getElementById("btnPause");
        btn.textContent = gameState.gamePaused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
      }

      // ===== INPUT HANDLING =====
      function setupJoystick() {
        const joystickArea = document.getElementById("joystickArea");
        const handle = document.getElementById("joystickHandle");
        const rect = joystickArea.getBoundingClientRect();

        gameState.joystick.baseX = rect.left + 50;
        gameState.joystick.baseY = rect.top + 50;

        function startTouch(e) {
          e.preventDefault();
          gameState.joystick.active = true;
          updateJoystick(e);
        }

        function moveTouch(e) {
          if (!gameState.joystick.active) return;
          e.preventDefault();
          updateJoystick(e);
        }

        function endTouch() {
          gameState.joystick.active = false;
          handle.style.transform = "translate(-50%, -50%)";
          gameState.joystick.x = 0;
          gameState.joystick.y = 0;
        }

        function updateJoystick(e) {
          const touch = e.touches ? e.touches[0] : e;
          const x = touch.clientX;
          const y = touch.clientY;

          const dx = x - gameState.joystick.baseX;
          const dy = y - gameState.joystick.baseY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const maxDistance = 40;

          if (distance > maxDistance) {
            const angle = Math.atan2(dy, dx);
            gameState.joystick.x = Math.cos(angle);
            gameState.joystick.y = Math.sin(angle);
            handle.style.transform = `translate(${Math.cos(angle) * maxDistance - 25}px, ${Math.sin(angle) * maxDistance - 25}px)`;
          } else {
            gameState.joystick.x = dx / maxDistance;
            gameState.joystick.y = dy / maxDistance;
            handle.style.transform = `translate(${dx - 25}px, ${dy - 25}px)`;
          }
        }

        // Mouse events for desktop
        joystickArea.addEventListener("mousedown", startTouch);
        document.addEventListener("mousemove", moveTouch);
        document.addEventListener("mouseup", endTouch);

        // Touch events for mobile
        joystickArea.addEventListener("touchstart", startTouch);
        document.addEventListener("touchmove", moveTouch);
        document.addEventListener("touchend", endTouch);
      }

      function startShooting() {
        gameState.shooting = true;
      }

      function stopShooting() {
        gameState.shooting = false;
      }

      // ===== UPDATE FUNCTIONS =====
      function update(deltaTime) {
        if (gameState.gamePaused || !gameState.gameActive) return;

        // Update game time
        gameState.gameTime += deltaTime;

        // Update player
        updatePlayer(deltaTime);

        // Update enemies
        updateEnemies(deltaTime);

        // Update bullets
        updateBullets(deltaTime);

        // Update particles
        updateParticles(deltaTime);

        // Update power ups
        updatePowerUps(deltaTime);

        // Spawn enemies
        updateSpawning(deltaTime);

        // Update power up timers
        updatePowerUpTimers(deltaTime);

        // Check wave completion
        if (gameState.enemiesKilled >= gameState.waveEnemies) {
          if (
            gameState.mode === "campaign" &&
            gameState.wave >= CONFIG.WAVES.campaign
          ) {
            // Campaign completed
            document.getElementById("gameOverTitle").textContent = "VICTORY!";
            gameOver();
          } else {
            gameState.wave++;
            gameState.enemiesKilled = 0;
            gameState.waveEnemies = calculateWaveEnemies();
            showWaveIndicator();
          }
        }

        // Shoot if button pressed
        if (gameState.shooting) {
          shoot();
        }
      }

      function updatePlayer(deltaTime) {
        // Movement
        if (gameState.joystick.active) {
          gameState.player.x += gameState.joystick.x * gameState.player.speed;
          gameState.player.y += gameState.joystick.y * gameState.player.speed;
        }

        // Keep player in bounds
        gameState.player.x = Math.max(
          CONFIG.PLAYER_SIZE,
          Math.min(
            CONFIG.CANVAS_WIDTH - CONFIG.PLAYER_SIZE,
            gameState.player.x,
          ),
        );
        gameState.player.y = Math.max(
          CONFIG.PLAYER_SIZE,
          Math.min(
            CONFIG.CANVAS_HEIGHT - CONFIG.PLAYER_SIZE,
            gameState.player.y,
          ),
        );

        // Update invulnerability
        if (gameState.player.invulnerable) {
          gameState.player.invulnerableTimer -= deltaTime * 0.016;
          if (gameState.player.invulnerableTimer <= 0) {
            gameState.player.invulnerable = false;
          }
        }
      }

      function updateEnemies(deltaTime) {
        for (let i = gameState.enemies.length - 1; i >= 0; i--) {
          const enemy = gameState.enemies[i];

          // Move towards player
          const dx = gameState.player.x - enemy.x;
          const dy = gameState.player.y - enemy.y;
          const dist = Math.sqrt(dx * dx + dy * dy);

          enemy.x += (dx / dist) * enemy.speed;
          enemy.y += (dy / dist) * enemy.speed;

          // Check collision with player
          const playerDist = Math.sqrt(
            Math.pow(enemy.x - gameState.player.x, 2) +
              Math.pow(enemy.y - gameState.player.y, 2),
          );

          if (playerDist < CONFIG.PLAYER_SIZE + enemy.size) {
            takeDamage(10);
            createExplosion(enemy.x, enemy.y, enemy.color);
            gameState.enemies.splice(i, 1);
            gameState.enemiesKilled++;
            continue;
          }

          // Check if off screen
          if (
            enemy.x < -100 ||
            enemy.x > CONFIG.CANVAS_WIDTH + 100 ||
            enemy.y < -100 ||
            enemy.y > CONFIG.CANVAS_HEIGHT + 100
          ) {
            gameState.enemies.splice(i, 1);
          }
        }
      }

      function updateBullets(deltaTime) {
        for (let i = gameState.bullets.length - 1; i >= 0; i--) {
          const bullet = gameState.bullets[i];

          bullet.x += bullet.vx;
          bullet.y += bullet.vy;
          bullet.lifetime--;

          // Check collision with enemies
          for (let j = gameState.enemies.length - 1; j >= 0; j--) {
            const enemy = gameState.enemies[j];
            const dx = bullet.x - enemy.x;
            const dy = bullet.y - enemy.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < bullet.size + enemy.size) {
              // Hit!
              createExplosion(enemy.x, enemy.y, enemy.color);
              gameState.enemies.splice(j, 1);
              gameState.bullets.splice(i, 1);
              gameState.player.kills++;
              gameState.player.score += 100;
              gameState.enemiesKilled++;
              spawnPowerUp(enemy.x, enemy.y);
              playSound(400, "sine", 0.1);
              break;
            }
          }

          // Remove if off screen or expired
          if (
            bullet.lifetime <= 0 ||
            bullet.x < -50 ||
            bullet.x > CONFIG.CANVAS_WIDTH + 50 ||
            bullet.y < -50 ||
            bullet.y > CONFIG.CANVAS_HEIGHT + 50
          ) {
            gameState.bullets.splice(i, 1);
          }
        }
      }

      function updateParticles(deltaTime) {
        for (let i = gameState.particles.length - 1; i >= 0; i--) {
          const particle = gameState.particles[i];

          particle.x += particle.vx;
          particle.y += particle.vy;
          particle.vy += 0.1; // Gravity
          particle.life -= particle.decay;

          if (particle.life <= 0) {
            gameState.particles.splice(i, 1);
          }
        }
      }

      function updatePowerUps(deltaTime) {
        for (let i = gameState.powerUps.length - 1; i >= 0; i--) {
          const powerUp = gameState.powerUps[i];

          powerUp.lifetime--;

          // Check collision with player
          const dx = powerUp.x - gameState.player.x;
          const dy = powerUp.y - gameState.player.y;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < CONFIG.PLAYER_SIZE + powerUp.size) {
            collectPowerUp(powerUp);
            gameState.powerUps.splice(i, 1);
            continue;
          }

          // Remove if expired
          if (powerUp.lifetime <= 0) {
            gameState.powerUps.splice(i, 1);
          }
        }
      }

      function updateSpawning(deltaTime) {
        gameState.lastSpawn += deltaTime * 0.016 * 60;

        const spawnRate = CONFIG.ENEMY_SPAWN_RATE[gameState.difficulty];
        const waveMultiplier = 1 + gameState.wave * 0.1;

        if (
          gameState.lastSpawn > spawnRate / waveMultiplier &&
          gameState.enemies.length < 20 + gameState.wave * 5
        ) {
          spawnEnemy();
          gameState.lastSpawn = 0;
        }
      }

      function updatePowerUpTimers(deltaTime) {
        // Update rapid fire
        if (gameState.powerUps.rapid.active) {
          gameState.powerUps.rapid.timer -= deltaTime * 0.016;
          const rapidBar = document.getElementById("rapidBar");
          rapidBar.style.width = `${(gameState.powerUps.rapid.timer / gameState.powerUps.rapid.maxTime) * 100}%`;

          if (gameState.powerUps.rapid.timer <= 0) {
            gameState.powerUps.rapid.active = false;
            document.getElementById("powerRapid").classList.remove("active");
          }
        }

        // Update shield
        if (gameState.powerUps.shield.active) {
          gameState.powerUps.shield.timer -= deltaTime * 0.016;
          const shieldBar = document.getElementById("shieldBar");
          shieldBar.style.width = `${(gameState.powerUps.shield.timer / gameState.powerUps.shield.maxTime) * 100}%`;

          if (gameState.powerUps.shield.timer <= 0) {
            gameState.powerUps.shield.active = false;
            document.getElementById("powerShield").classList.remove("active");
          }
        }
      }

      function createExplosion(x, y, color) {
        for (let i = 0; i < 20; i++) {
          const angle = Math.random() * Math.PI * 2;
          const speed = 1 + Math.random() * 4;

          gameState.particles.push({
            x,
            y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            size: 2 + Math.random() * 5,
            color,
            life: 1,
            decay: 0.03,
          });
        }
      }

      // ===== RENDERING =====
      function draw() {
        // Clear canvas
        ctx.fillStyle = "rgba(5, 5, 5, 0.2)";
        ctx.fillRect(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);

        // Draw grid
        drawGrid();

        // Draw player
        drawPlayer();

        // Draw enemies
        gameState.enemies.forEach(drawEnemy);

        // Draw bullets
        gameState.bullets.forEach(drawBullet);

        // Draw particles
        gameState.particles.forEach(drawParticle);

        // Draw power ups
        gameState.powerUps.forEach(drawPowerUp);

        // Draw shield if active
        if (gameState.powerUps.shield.active) {
          drawShield();
        }
      }

      function drawGrid() {
        ctx.strokeStyle = "rgba(59, 130, 246, 0.1)";
        ctx.lineWidth = 1;

        const gridSize = 100;

        // Vertical lines
        for (let x = 0; x < CONFIG.CANVAS_WIDTH; x += gridSize) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, CONFIG.CANVAS_HEIGHT);
          ctx.stroke();
        }

        // Horizontal lines
        for (let y = 0; y < CONFIG.CANVAS_HEIGHT; y += gridSize) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(CONFIG.CANVAS_WIDTH, y);
          ctx.stroke();
        }
      }

      function drawPlayer() {
        ctx.save();

        // Draw shield if invulnerable
        if (
          gameState.player.invulnerable &&
          Math.floor(gameState.gameTime * 10) % 2 === 0
        ) {
          ctx.strokeStyle = "#06b6d4";
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(
            gameState.player.x,
            gameState.player.y,
            CONFIG.PLAYER_SIZE + 5,
            0,
            Math.PI * 2,
          );
          ctx.stroke();
        }

        // Draw player
        ctx.fillStyle = "#3b82f6";
        ctx.beginPath();
        ctx.arc(
          gameState.player.x,
          gameState.player.y,
          CONFIG.PLAYER_SIZE,
          0,
          Math.PI * 2,
        );
        ctx.fill();

        // Draw player glow
        ctx.shadowColor = "#3b82f6";
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.arc(
          gameState.player.x,
          gameState.player.y,
          CONFIG.PLAYER_SIZE - 2,
          0,
          Math.PI * 2,
        );
        ctx.fill();
        ctx.shadowBlur = 0;

        // Draw direction indicator
        ctx.strokeStyle = "white";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(gameState.player.x, gameState.player.y);
        ctx.lineTo(
          gameState.player.x +
            Math.cos(
              Math.atan2(
                CONFIG.CANVAS_HEIGHT / 2 - gameState.player.y,
                CONFIG.CANVAS_WIDTH / 2 - gameState.player.x,
              ),
            ) *
              30,
          gameState.player.y +
            Math.sin(
              Math.atan2(
                CONFIG.CANVAS_HEIGHT / 2 - gameState.player.y,
                CONFIG.CANVAS_WIDTH / 2 - gameState.player.x,
              ),
            ) *
              30,
        );
        ctx.stroke();

        ctx.restore();
      }

      function drawEnemy(enemy) {
        ctx.save();

        ctx.fillStyle = enemy.color;
        ctx.beginPath();
        ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
        ctx.fill();

        // Enemy glow
        ctx.shadowColor = enemy.color;
        ctx.shadowBlur = 15;
        ctx.beginPath();
        ctx.arc(enemy.x, enemy.y, enemy.size - 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        ctx.restore();
      }

      function drawBullet(bullet) {
        ctx.save();

        ctx.fillStyle = bullet.color;
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2);
        ctx.fill();

        // Bullet trail
        ctx.strokeStyle = "#06b6d4";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(bullet.x - bullet.vx * 0.5, bullet.y - bullet.vy * 0.5);
        ctx.lineTo(bullet.x, bullet.y);
        ctx.stroke();

        ctx.restore();
      }

      function drawParticle(particle) {
        ctx.save();

        ctx.globalAlpha = particle.life;
        ctx.fillStyle = particle.color;
        ctx.beginPath();
        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
      }

      function drawPowerUp(powerUp) {
        ctx.save();

        // Pulsing effect
        const pulse = Math.sin(gameState.gameTime * 10) * 0.2 + 0.8;

        ctx.fillStyle = powerUp.color;
        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.arc(powerUp.x, powerUp.y, powerUp.size * pulse, 0, Math.PI * 2);
        ctx.fill();

        // Draw icon (simplified)
        ctx.fillStyle = "white";
        ctx.font = "16px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(powerUp.icon, powerUp.x, powerUp.y);

        ctx.restore();
      }

      function drawShield() {
        ctx.save();

        ctx.strokeStyle = "#06b6d4";
        ctx.lineWidth = 3;
        ctx.globalAlpha = 0.5;
        ctx.setLineDash([10, 5]);
        ctx.beginPath();
        ctx.arc(
          gameState.player.x,
          gameState.player.y,
          CONFIG.PLAYER_SIZE + 15,
          0,
          Math.PI * 2,
        );
        ctx.stroke();

        ctx.restore();
      }

      // ===== HUD & UI =====
      function updateHUD() {
        document.getElementById("score").textContent = gameState.player.score;
        document.getElementById("wave").textContent = gameState.wave;
        document.getElementById("healthBar").style.width =
          `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      // ===== AUDIO =====
      function playSound(frequency, type, duration = 0.1) {
        if (!gameState.soundEnabled || !gameState.audioContext) return;

        try {
          const oscillator = gameState.audioContext.createOscillator();
          const gainNode = gameState.audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(gameState.audioContext.destination);

          oscillator.type = type;
          oscillator.frequency.setValueAtTime(
            frequency,
            gameState.audioContext.currentTime,
          );

          gainNode.gain.setValueAtTime(0.1, gameState.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.001,
            gameState.audioContext.currentTime + duration,
          );

          oscillator.start();
          oscillator.stop(gameState.audioContext.currentTime + duration);
        } catch (e) {
          console.warn("Audio error:", e);
        }
      }

      // ===== GAME LOOP =====
      let lastTime = 0;
      function gameLoop(timestamp) {
        if (!gameState.gameActive) return;

        const deltaTime = timestamp - lastTime || 0;
        lastTime = timestamp;

        update(deltaTime);
        draw();
        requestAnimationFrame(gameLoop);
      }

      // ===== INITIALIZATION =====
      window.addEventListener("load", () => {
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        // Set default selections
        selectMode("survival");
        selectDifficulty("normal");

        // Keyboard controls for desktop
        window.addEventListener("keydown", (e) => {
          if (!gameState.gameActive) return;

          switch (e.code) {
            case "KeyW":
            case "ArrowUp":
              gameState.joystick.y = -1;
              break;
            case "KeyS":
            case "ArrowDown":
              gameState.joystick.y = 1;
              break;
            case "KeyA":
            case "ArrowLeft":
              gameState.joystick.x = -1;
              break;
            case "KeyD":
            case "ArrowRight":
              gameState.joystick.x = 1;
              break;
            case "Space":
              startShooting();
              break;
          }
        });

        window.addEventListener("keyup", (e) => {
          if (!gameState.gameActive) return;

          switch (e.code) {
            case "KeyW":
            case "ArrowUp":
            case "KeyS":
            case "ArrowDown":
              gameState.joystick.y = 0;
              break;
            case "KeyA":
            case "ArrowLeft":
            case "KeyD":
            case "ArrowRight":
              gameState.joystick.x = 0;
              break;
            case "Space":
              stopShooting();
              break;
          }
        });
      });
    </script>
  </body>
</html>
